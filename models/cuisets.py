"""
cuisets.py
by Ted Morin

used to produce the CUI table
CUIsets string variable generated mostly from `models` table with command:
SELECT id,DOI,uncompiled,mustCUI,mustnotCUI,inpCUI,outcomeCUI,outputCUI FROM `models`
"""


import json
import sql

CUIsets = [
['''1''','''10.1001/archinte.167.10.1068''','''["model_a.py"]''','''[""]''','''["C1832387"]''','''["C0086582", "C0804405", "C0488055", "C0488052", "C1542867", "C0364221", "C0364714", "C0363687", "C1313937", "C0684167"]''','''C1832387''',],
['''2''','''10.1001/archinte.167.10.1068''','''["model_b.py"]''','''[""]''','''["C1832387"]''','''["C0086582", "C0804405", "C0488055", "C0488052", "C1542867", "C0364221", "C0364714", "C0363687", "C1313937", "C0684167"]''','''C1832387''',],
['''3''','''10.1001/archinte.167.10.1068''','''["model_c.py"]''','''[""]''','''["C1832387"]''','''["C0086582", "C0804405", "C0488055", "C0488052", "C2734066", "C0364221", "C0364714", "C0363687", "C1313937", "C0684167"]''','''C1832387''',],
['''4''','''10.1001/archinte.167.10.1068''','''["model_d.py"]''','''[""]''','''["C1832387"]''','''["C0086582", "C0804405", "C0488055", "C0488052", "C1542867", "C2734066", "C0364221", "C0364714", "C0363687", "C1313937", "C0684167"]''','''C1832387''',],
['''5''','''10.1001/archinte.159.11.1197''','''["model_a.py"]''','''["C2926063 or C1963123 or C1717437"]''','''[""]''','''["C0086582", "C0804405", "C3484363", "C0802682", "C0488794", "C0488055", "C2926063", "C1963123", "C1315719", "C0018800"]''','''C0018801''','''C3176374'''],
['''6''','''10.1001/archinte.159.11.1197''','''["model_b.py"]''','''["C2926063 or C1963123 or C1717437"]''','''[""]''','''["C0086582", "C0804405", "C3484363", "C0488794", "C0488055", "C2926063", "C1963123", "C1315719", "C1542867"]''','''C0018801''','''C3176374'''],
['''7''','''10.1016/S0140-6736(09)60443-8''','''["model.py"]''','''[""]''','''["C0004238"]''','''["C0086582", "C0804405", "C1542867", "C0488055", "C0684167", "C0488345", "C1963123", "C0018801"]''','''C0004238''','''C3176364'''],
['''8''','''10.1016/S0002-8703(00)90236-9''','''["model_a.py"]''','''[""]''','''["C0018802"]''','''["C0086582", "C0804405", "C0364708", "C0364221", "C0488055", "C1716143", "C0684167", "C1315719", "C3173717", "CL447856"]''','''C0018802''',],
['''9''','''10.1016/S0002-8703(00)90236-9''','''["model_b.py"]''','''[""]''','''["C0018802"]''','''["C0086582", "C0804405", "C0364708", "C0364221", "C0488055", "C1716143", "C0684167", "C1315719", "C3173717", "CL447856"]''','''C0018802''',],
['''10''','''10.1016/S0002-8703(00)90236-9''','''["model_c.py"]''','''[""]''','''["C0018802", "C0086582"]''','''["C0804405", "C0364708", "C0364221", "C0488055", "C1716143", "C0364714", "C0684167", "C1315719", "C3173717", "CL447856"]''','''C0018802''',],
['''11''','''10.1016/S0002-8703(00)90236-9''','''["model_d.py"]''','''[""]''','''["C0018802", "C0086582"]''','''["C0804405", "C0364708", "C0364221", "C0488055", "C1716143", "C0364714", "C0684167", "C1315719", "C3173717", "CL447856"]''','''C0018802''',],
['''12''','''10.1016/S0002-8703(00)90236-9''','''["model_e.py"]''','''["C0018802"]''','''[""]''','''["C0086582", "C0804405", "C0364708", "C0364221", "C0488055", "C1315719", "C3173717"]''','''C0018802''',],
['''13''','''10.1016/S0002-8703(00)90236-9''','''["model_f.py"]''','''["C0018802"]''','''[""]''','''["C0086582", "C0804405", "C0364708", "C0364221", "C0488055", "C1315719", "C3173717"]''','''C0018802''',],
['''14''','''10.1161/01.CIR.96.1.44''','''["model_a.py"]''','''[""]''','''["C0021775"]''','''["C0086582", "C0804405", "C0488055", "C0488052", "C3169451", "C0364708", "C1315719", "C2926063"]''','''C0021775''','''C3176361'''],
['''15''','''10.1161/01.CIR.96.1.44''','''["model_b.py"]''','''[""]''','''["C0021775"]''','''["C0086582", "C0804405", "C0488055", "C0488052", "C3169451", "C0364708", "C1315719", "C2926063"]''','''C0021775''','''C3176361'''],
['''16''','''10.1161/CIRCULATIONAHA.107.699579''','''["model.py"]''','''[""]''','''["C0007222"]''','''["C0086582", "C0684167", "C0804405", "C0364708", "C0364221", "C0488055", "C3496611", "C1315719"]''','''C0007222''','''C3176186'''],
['''17''','''10.7326/0003-4819-148-2-200801150-00005''','''["model_a.py"]''','''[""]''','''["C1717437"]''','''["C0086582", "C0804405", "C0488055", "C0488052", "C1542867", "C3496611", "C2713447"]''','''C1717437''',],
['''18''','''10.7326/0003-4819-148-2-200801150-00005''','''["model_b.py"]''','''[""]''','''["C1717437"]''','''["C0086582", "C0804405", "C0488055", "C0488052", "C1542867", "C3496611", "C2713447"]''','''C1717437''',],
['''19''','''10.7326/0003-4819-148-2-200801150-00005''','''["model_c.py"]''','''[""]''','''["C1717437"]''','''["C0086582", "C0804405", "C0488055", "C0488052", "C1542867", "C3496611", "C2713447"]''','''C1717437''',],
['''20''','''10.7326/0003-4819-148-2-200801150-00005''','''["model_d.py"]''','''[""]''','''["C1717437"]''','''["C0086582", "C0804405", "C0488055", "C0488052", "C1542867", "C3496611", "C2713447"]''','''C1717437''',],
['''21''','''10.7326/0003-4819-148-2-200801150-00005''','''["model_e.py"]''','''[""]''','''["C1717437"]''','''["C0086582", "C0804405", "C0488055", "C0488052", "C1542867", "C3496611", "C2713447"]''','''C1717437''',],
['''22''','''10.7326/0003-4819-148-2-200801150-00005''','''["model_f.py"]''','''[""]''','''["C1717437"]''','''["C0086582", "C0804405", "C0488055", "C0488052", "C1542867", "C3496611", "C2713447"]''','''C1717437''',],
['''23''','''10.1161/01.CIR.97.18.1837''','''["model_a.py"]''','''[""]''','''["C2926063"]''','''["C0086582", "C0804405", "C0364708", "C0364221", "C0488055", "C0488052", "C1315719", "C3496611"]''','''C2926063''','''C3176182'''],
['''24''','''10.1161/01.CIR.97.18.1837''','''["model_b.py"]''','''[""]''','''["C2926063"]''','''["C0086582", "C0804405", "C0364225", "C0364221", "C0488055", "C0488052", "C1315719", "C3496611"]''','''C2926063''','''C3176182'''],
['''25''','''10.1161/01.CIR.97.18.1837''','''["model_c.py"]''','''[""]''','''["C2926063"]''','''["C0086582", "C0804405", "C0364708", "C0364221", "C0488055", "C0488052", "C1315719", "C3496611"]''','''C2926063''','''C3176182'''],
['''26''','''10.1161/01.CIR.97.18.1837''','''["model_d.py"]''','''[""]''','''["C2926063"]''','''["C0086582", "C0804405", "C0364225", "C0364221", "C0488055", "C0488052", "C1315719", "C3496611"]''','''C2926063''','''C3176182'''],
['''27''','''10.1093/eurjhf:hft041''','''["model.py"]''','''["C0004238"]''','''["C0018802"]''','''["C0804405", "C1542867", "C3484363", "C1315719", "C1963123", "C2926063"]''','''C0018802''',],
['''28''','''10.1161/CIRCULATIONAHA.108.816694''','''["modela.py"]''','''[""]''','''["C0007222", "C2707253"]''','''["C0086582", "C0804405", "C0488055", "C0684167", "C3496611", "C1315719", "C0364708", "C0364221"]''','''C0007222''',],
['''29''','''10.1161/CIRCULATIONAHA.108.816694''','''["modelb.py"]''','''[""]''','''["C0007222", "C2707253"]''','''["C0086582", "C0804405", "C0488055", "C0684167", "C3496611", "C1315719", "C0364708", "C0364221"]''','''C2926092 or C2926063 or C0038454''',],
['''30''','''10.1161/CIRCULATIONAHA.108.816694''','''["modelc.py"]''','''[""]''','''["C0007222", "C2707253"]''','''["C0086582", "C0804405", "C0488055", "C0684167", "C3496611", "C1315719", "C1542867"]''','''C0007222''',],
['''31''','''10.1161/CIRCULATIONAHA.108.816694''','''["modeld.py"]''','''[""]''','''["C0007222", "C2707253"]''','''["C0086582", "C0804405", "C0488055", "C0684167", "C3496611", "C1315719", "C1542867"]''','''C2926092 or C2926063 or C0038454''',]
]
print len( CUIsets )

# SELECT id,DOI,uncompiled,mustCUI,mustnotCUI,inpCUI,outcomeCUI,outputCUI
allCUIs = {}
for row in CUIsets:
    #print row[0],row[1],row[2][2:-2]
    modelID = row[0]
    mustCUIs = json.loads(row[3])
    mustnotCUIs = json.loads(row[4])
    inpCUIs = json.loads(row[5])
    outcomeCUIs = [row[6]]
    rowCUIs = mustCUIs + mustnotCUIs+inpCUIs + outcomeCUIs
    outputCUIs = []
    if len(row) == 8:
        outputCUIs = [row[7]]
        rowCUIs += outputCUIs
    for CUI in rowCUIs:
        if not allCUIs.has_key(CUI):
            #print CUI
            allCUIs[CUI] = [[],[],[],[],[]]
        if CUI in mustCUIs:
            allCUIs[CUI][0].append(modelID)
        if CUI in mustnotCUIs:
            allCUIs[CUI][1].append(modelID)
        if CUI in inpCUIs:
            allCUIs[CUI][2].append(modelID)
        if CUI in outcomeCUIs:
            allCUIs[CUI][3].append(modelID)
        if CUI in outputCUIs:
            allCUIs[CUI][4].append(modelID)
            
del allCUIs[""]
###########################################################################

values = []
for key in allCUIs.keys():
    values.append([key] + [json.dumps(group) for group in allCUIs[key]])


print len(values)

CUIs_table = sql.Table('CUIs')
columns = [
    CUIs_table.CUI,
    CUIs_table.must,
    CUIs_table.mustnot,
    CUIs_table.input,
    CUIs_table.outcome,
    CUIs_table.output
]

insertion = CUIs_table.insert(columns = columns, values = values)
CUIs_tup = tuple(insertion)
query = CUIs_tup[0].replace('"','').replace('%s',"'%s'")

query = query % tuple(CUIs_tup[1])

with open('cuisets.sql','w') as output_file:
    output_file.write(query)
